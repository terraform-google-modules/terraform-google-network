apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: add-argo-sync-wave-rook
  annotations:
    policies.kyverno.io/title: Add sync wave value for rook-ceph crds
    policies.kyverno.io/category: rook-ceph
    policies.kyverno.io/subject: crd, mutate, Annotation
    argocd.argoproj.io/sync-options: Force=true,Replace=true
spec:
  failurePolicy: Ignore
  webhookTimeoutSeconds: 5
  rules:
  - name: add-argo-sync-wave-rook
    match:
      any:
      - resources:
          kinds:
            - CustomResourceDefinition
          names:
            - ceph*
    preconditions:
      - key: "{{`{{request.operation}}`}}"
        operator: AnyIn
        value:
          - CREATE
          - UPDATE
    skipBackgroundRequests: true
    mutate:
      targets:
        - apiVersion: apiextensions.k8s.io/v1
          kind: CustomResourceDefinition
          name: "{{`{{request.object.metadata.name}}`}}"
      patchStrategicMerge:
        metadata:
          annotations:
            +(argocd.argoproj.io/sync-wave): "-1"