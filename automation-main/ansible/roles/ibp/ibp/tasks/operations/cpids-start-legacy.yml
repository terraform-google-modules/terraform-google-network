
# Start LJS
- name: Test if LJS is started
  become: true
  shell: ./DSOD_Server.sh checkStatus
  args:
    chdir: /usr/sap/dsod_package
  register: DSOD_Server_checkStatus

- name: "Check if LJS is already started"
  assert:
    that: DSOD_Server_checkStatus.stdout | regex_search('LJS_.*_Daemon is started.')
    fail_msg: LJS not up. Starting in next block
    success_msg: "LJS is already started. Skipping next block"
  changed_when: false
  failed_when: false

- name: "Block: Start LJS"
  when: DSOD_Server_checkStatus.stdout | regex_search('((?!LJS_.*_Daemon is stopped).)*')
  # Breakdown of Regex as follows:
  # ()* : Evaluate all matches of the paranthesis.
  # (). : Include results of paranthesis plus any following character
  # ?!  : Negative lookahead. The next evaluation is not true
  # .*  : Any characters here.
  become: true
  block:
  - name: Start LJS
    shell: nohup /usr/sap/dsod_package/DSOD_Server.sh start &

  - name: Test if LJS is Started
    become: true
    shell: /usr/sap/dsod_package/DSOD_Server.sh checkStatus
    register: DSOD_Server_new_status

  - name: Validate LJS Start
    assert:
      that: DSOD_Server_new_status.stdout | regex_search('LJS_.*_Daemon is started.')
      fail_msg: |
        LJS did not start
        {{ DSOD_Server_new_status.stdout }}
      success_msg: LJS Started
  # End "Block: Start LJS"

# Start ActiveMQ

- name: Test ActiveMQ URI http://127.0.0.1:8161
  uri:
    url: "http://127.0.0.1:8161"
  failed_when: false
  register: results_activemq_uri

- name: Check if ActiveMQ is up.
  assert:
    that: results_activemq_uri.status == 200
    fail_msg: ActiveMQ URI is not up, starting in next block
    success_msg: ActiveMQ URI is up, skipping next block
  changed_when: false
  failed_when: false

- name: "Block: Start ActiveMQ"
  when: results_activemq_uri.status != 200
  become: true
  block:
  - name: Start ActiveMQ
    shell: nohup /usr/sap/dsod_package/activemq/bin/activemq-admin start &
    environment:
      JAVA_HOME: '/usr/sap/dsod_package/sapjvm_7'
      PATH: '/usr/sap/dsod_package/sapjvm_7/bin:.:/usr/local/sbin:/usr/local/bin:{{ ansible_env.PATH }}:/root/bin'

  - name: Test ActiveMQ URI http://127.0.0.1:8161 Post Start
    uri:
      url: "http://127.0.0.1:8161"
      return_content: yes
    register: results_activemq_uri_poststart
    retries: 6
    delay: 5
    until: results_activemq_uri_poststart.status == 200

  - name: "Validate ActiveMQ Start"
    assert:
      that: results_activemq_uri_poststart.status == 200
      fail_msg: |
        ActiveMQ did not start
         {{ results_activemq_uri_poststart.content }}
      success_msg: ActiveMQ Started
  # End "Block: Stop ActiveMQ"
