# Stop ActiveMQ

- name: Test ActiveMQ URI http://127.0.0.1:8161
  uri:
    url: "http://127.0.0.1:8161"
  ignore_errors: yes
  register: results_activemq_uri

- name: Check if ActiveMQ is up.
  assert:
    that: results_activemq_uri.status != 200
    fail_msg: ActiveMQ URI is up, stopping in next block
    success_msg: ActiveMQ URI is down, skipping next block
  changed_when: false
  failed_when: false

- name: "Block: Stop ActiveMQ"
  when: results_activemq_uri.status == 200
  become: true
  block:
  - name: Stop ActiveMQ
    shell: /usr/sap/dsod_package/activemq/bin/activemq-admin stop
    environment:
      JAVA_HOME: '/usr/sap/dsod_package/sapmachine-jdk'
      PATH: '/usr/sap/dsod_package/sapmachine-jdk/bin:.:/usr/local/sbin:/usr/local/bin:{{ ansible_env.PATH }}:/root/bin'

  - name: Test ActiveMQ URI http://127.0.0.1:8161 Post Stop
    uri:
      url: "http://127.0.0.1:8161"
      return_content: yes
    register: results_activemq_uri_poststop
    failed_when: false
    changed_when: false

  - name: "Validate ActiveMQ Stop"
    assert:
      that: "results_activemq_uri_poststop.status != 200"
      fail_msg: |
        ActiveMQ did not stop
         {{ results_activemq_uri_poststop.content }}
      success_msg: ActiveMQ Stopped
  # End "Block: Stop ActiveMQ"

- name: Stop Kotyo
  become: true
  environment:
    JAVA_HOME: '/usr/sap/dsod_package/sapmachine-jdk'
    PATH: '/usr/sap/dsod_package/sapmachine-jdk/bin:.:/usr/local/sbin:/usr/local/bin:{{ ansible_env.PATH }}:/root/bin'
  shell: 'nohup ./shutdown.sh &'
  args:
    chdir: /usr/sap/dsod_package/kotyo/bin
  register: kotyo_stop_output

- name: Display Kotyo Start Output
  debug:
    var: kotyo_stop_output.stdout_lines
