---
# Synopsis: Does a hard start of SAPAPP
# Inputs:
#   - sid : (provided by playbook) SAP ID of the system
# Outputs: Started SAPAPP
# Comments: N/A

- name: "Run sapstartsrv"
  shell: "{{ item }}"
  become: true
  become_user: "{{ sid|lower }}adm"
  args:
    executable: '/bin/csh'
  register: sapstartsrv_output
  loop:
  - "/usr/sap/{{ sid|upper }}/ASCS01/exe/sapstartsrv pf=/usr/sap/{{ sid|upper }}/SYS/profile/{{ sid|upper }}_ASCS01_ibpapp01-{{ sid|lower }} -D"
  - "/usr/sap/{{ sid|upper }}/DVEBMGS00/exe/sapstartsrv pf=/usr/sap/{{ sid|upper }}/SYS/profile/{{ sid|upper }}_DVEBMGS00_ibpapp01-{{ sid|lower }} -D"

- name: "Get saphostagent status"
  command: "/usr/sap/hostctrl/exe/saphostexec -status"
  become: true
  register: saphostagent_status
  failed_when: "'FAILED' in saphostagent_status.stderr"
  changed_when: false

- name: "Display saphostagent status"
  debug:
    var: saphostagent_status.stderr_lines

- name: "BLOCK - Start saphostagent"
  when: saphostagent_status.stderr == 'saphostexec stopped'
  block:
  - name: "Start saphostagent as root"
    command: "/usr/sap/hostctrl/exe/saphostexec -restart"
    become: true

  - name: "Get saphostagent status"
    command: "/usr/sap/hostctrl/exe/saphostexec -status"
    become: true
    register: saphostagent_statusblock
    failed_when: "'FAILED' in saphostagent_statusblock.stderr"
    changed_when: false

  - name: "Display saphostagent status"
    debug:
      var: saphostagent_statusblock.stderr_lines
  #End "BLOCK - Start saphostagent"

- name: Start SAPAPP
  include_tasks: operations/sapapp-softstart.yml
...