---
# Synopsis: Silent installation of SAP BI Platform for Lumira and Lumira Server
# Inputs:
#   spr_app_install_hostname: Hostname of the application instance
#   spr_app_install_hostname_bip: Hostname of the standalone BIP App Server
#   spr_app_install_sid: Sid of the application instance
#   spr_app_install_file_ini_params_bip4lumira: Filepath to the configuration file for bip, SID-Lumira-BIP-response.ini
#   spr_app_install_file_ini_params_lumira: Filepath to the configuration file for Lumira, SID-Lumira-Server-response.ini
#   spr_app_install_domain: FQDN of the target environment
#   spr_app_install_product: Product to install
#   spr_app_install_file_bip_setup_sh: Filepath to the setup.sh executable for SAP BIP, found under the Media directory. For BIP, it should be from media ending with 'ONE'
#   spr_app_install_file_lumira_setup_sh: Filepath to the setup.sh executable for SAP Lumira, found under the Media directory of Lumira
#   spr_app_install_productkey_bip: Productkey for BIP
# Notes: This must be run ONLY after BIP Install using bobj-bip-install.yml
# Outputs:
# Comments:


- name: Install required prerequisite packages
  become: true
  yum:
    name:
    - ksh
    - libnsl.so.1
    - libnsl.i686
    - libstdc++.i686
    - libstdc++.x86_64
    - glibc.i686
    - glibc.x86_64
    - libX11.i686
    - libX11.x86_64
    - libXext.i686
    - libXext.x86_64
    - expat.i686
    - expat.x86_64
    - libgcc.i686
    - libgcc.x86_64
    - libXcursor.i686
    - libXcursor.x86_64
    - libXrender.i686
    - libXrender.x86_64
    - libXfixes.i686
    - libXfixes.x86_64
    - libxcb.i686
    - libxcb.x86_64
    - libXau.i686
    - libXau.x86_64
    - xz-libs.i686
    - libnsl-2.28-42.el8.i686
    - libxcrypt-4.1.1-4.el8.i686
    - libnsl.x86_64
    - xz-libs-5.2.4-3.el8.i686
    state: present

# BEGIN BLOCK: Install SAP BIP for Lumira
- name: "BLOCK: Install SAP BIP for Lumira"
  block:
      - name: Create [sid]adm user
        become: true
        ansible.builtin.user:
          name: "{{ spr_app_install_sid|lower }}adm"
          group: sapsys
          shell: '/bin/bash'
          comment: "SAP System Administrator"

      - name: Create /usr/sap/{{ spr_app_install_sid|upper }}/tmp
        become: true
        file:
          path: "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/"
          state: directory
          owner: "{{ spr_app_install_sid|lower }}adm"
          group: sapsys

      - name: Set ulimit for [sid]adm
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        shell: ulimit

      - name: Save configuration file to /usr/sap/{{ spr_app_install_sid|upper }}/tmp
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        copy:
          dest: "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/"
          src: "{{ spr_app_install_file_ini_params_bip4lumira }}"
          force: yes
          remote_src: yes

      - name: Update SAP BIP for Lumira Response.ini values
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        no_log: true
        ini_file:
          path: "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_bip4lumira.split('/')[-1] }}"
          create: no
          section: null
          option: "{{ item.name }}"
          value: '{{ item.value }}'
          no_extra_spaces: true
        loop_control:
          label: "Modifying value of {{ item.name }} to {{ item.value }} in {{ spr_app_install_file_ini_params_bip4lumira }}"
        loop:
          - { name: 'enableservers', value: '1' }
          - { name: 'productkey', value: "{{ spr_app_install_productkey_bip }}" }
          - { name: 'installdir', value: '/usr/sap/{{ spr_app_install_sid|upper }}/' }
          - { name: 'remotecmsadminpassword', value: '{{ standard_deployment_password }}' }
          - { name: 'remotecmsport', value: '6400' }
          - { name: 'remotecmsadminname', value: 'Administrator' }
          - { name: 'remotecmsname', value: '{{ spr_app_install_hostname_bip }}' }
          - { name: 'sianame', value: '{{ spr_app_install_hostname }}' }
          - { name: 'siaport', value: '6410' }
          - { name: 'wacsport', value: '6405' }


# Run the .bashrc as soon as Shell is invoked.
# Also the BOBJ Installs must be performed as <sid>adm user. Not the root user
      - name: Execute silent installation of SAP BIP for Lumira
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        shell:
          "source ~/.bashrc;
          {{ spr_app_install_file_bip_setup_sh }}
          -r /usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_bip4lumira.split('/')[-1] }}
          -InstallDir /usr/sap/{{ spr_app_install_sid|upper }}"
        args:
          chdir: '/'

# Let us remove the BIP for Lumira ini file after install
      - name: Remove BIP Response.ini file after install
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        ansible.builtin.file:
          path:  "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_bip4lumira.split('/')[-1] }}"
          state: absent

# END BLOCK: Install SAP BIP for Lumira


# BEGIN BLOCK: Install SAP Lumira Server
- name: "BLOCK: Install SAP Lumira Server"
  block:
      - name: Save configuration file to /usr/sap/{{ spr_app_install_sid|upper }}/tmp
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        copy:
          dest: "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/"
          src: "{{ spr_app_install_file_ini_params_lumira }}"
          force: yes
          remote_src: yes

      - name: Update SAP  Lumira Server Response.ini values
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        no_log: true
        ini_file:
          path: "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_lumira.split('/')[-1] }}"
          create: no
          section: null
          option: "{{ item.name }}"
          value: '{{ item.value }}'
          no_extra_spaces: true
        loop_control:
          label: "Modifying value of {{ item.name }} to {{ item.value }} in {{ spr_app_install_file_ini_params_lumira }}"
        loop:
          - { name: 'launchwdeploy', value: 'true' }
          - { name: 'installdir', value: '/usr/sap/{{ spr_app_install_sid|upper }}/' }
          - { name: 'remotecmsadminpassword', value: '{{ standard_deployment_password }}' }
          - { name: 'remotecmsport', value: '6400' }
          - { name: 'remotecmsadminname', value: 'Administrator' }
          - { name: 'remotecmsname', value: '{{ spr_app_install_hostname_bip }}' }


# Run the .bashrc as soon as Shell is invoked.
# Also the BOBJ Installs must be performed as <sid>adm user. Not the root user
      - name: Execute silent installation of SAP Lumira Server
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        shell:
          "source ~/.bashrc;
          {{ spr_app_install_file_lumira_setup_sh }}
          -r /usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_lumira.split('/')[-1] }}
          -InstallDir /usr/sap/{{ spr_app_install_sid|upper }}"
        args:
          chdir: '/'

# Let us remove the Lumira Server Response.ini file after install
      - name: Remove Lumira Server ini file after install
        become: true
        become_user: "{{ spr_app_install_sid|lower }}adm"
        ansible.builtin.file:
          path:  "/usr/sap/{{ spr_app_install_sid|upper }}/tmp/{{ spr_app_install_file_ini_params_lumira.split('/')[-1] }}"
          state: absent

# END BLOCK: Install SAP Lumira Server
...
