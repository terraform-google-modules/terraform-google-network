---
# Synopsis: Does a software start of Web Dispatcher
# Inputs:
#   - spr_webdispatcher_softstart_sid : SAP ID of the system
# Outputs: Started Web Dispatcher

- name: "Get Process list"
  shell: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64/sapcontrol -nr 00 -function GetProcessList'
  environment:
    LD_LIBRARY_PATH: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/hdbclient'
    DIR_LIBRARY: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run'
  become: true
  become_user: "{{ spr_webdispatcher_softstart_sid|lower }}adm"
  failed_when: false
  changed_when: false
  register: webdispatcher_process_output

- name: "Check if Web Dispatcher is already stopped"
  assert:
    that: |
        'GREEN' not in webdispatcher_process_output.stdout
    success_msg: Web Dispatcher process not detected. Starting in next block
    fail_msg: Web Dispatcher is already started. Skipping next block
  changed_when: false
  failed_when: false

- name: "BLOCK: Start Web Dispatcher"
  when: "'GREEN' not in webdispatcher_process_output.stdout"
  become: true
  become_user: "{{ spr_webdispatcher_softstart_sid|lower }}adm"
  block:
      - name: "Starting Web Dispatcher"
        shell: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64/sapcontrol -nr 00 -function StartSystem ALL'
        environment:
          LD_LIBRARY_PATH: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/hdbclient'
          DIR_LIBRARY: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run'
        register: webdispatcher_start_output
        failed_when: "'FAIL' in webdispatcher_start_output.stdout"

      - name: "Wait for process to start"
        shell: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64/sapcontrol -nr 00 -function GetProcessList'
        environment:
          LD_LIBRARY_PATH: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/uc/linuxx86_64:/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/hdbclient'
          DIR_LIBRARY: '/usr/sap/{{ spr_webdispatcher_softstart_sid|upper }}/SYS/exe/run'
        failed_when: false
        changed_when: false
        register: webdispatcher_poststart_process_output
        retries: 10
        delay: 10
        until: |
          'GRAY' not in webdispatcher_poststart_process_output.stdout and
          'YELLOW' not in webdispatcher_poststart_process_output.stdout and
          'GREEN' in webdispatcher_poststart_process_output.stdout

      - name: "Output post-start processes"
        debug:
          var: webdispatcher_poststart_process_output.stdout_lines
  # End "BLOCK: Start Web Dispatcher"

...
