---
# +----------------------------------------------------------------------------------------+
# | __   __      _             _                   _              ___           __ _       |
# | \ \ / /__ __| |_ ___ _ _  | |   ___  __ _ __ _(_)_ _  __ _   / __|___ _ _  / _(_)__ _  |
# |  \ V / -_) _|  _/ _ \ '_| | |__/ _ \/ _` / _` | | ' \/ _` | | (__/ _ \ ' \|  _| / _` | |
# |   \_/\___\__|\__\___/_|   |____\___/\__, \__, |_|_||_\__, |  \___\___/_||_|_| |_\__, | |
# |                                     |___/|___/       |___/                      |___/  |
# | Managed by Ansible                                                                     |
# +----------------------------------------------------------------------------------------+
#
# Description: Enrich log events with GCP Metadata
# Vector Output Name: gcp_metadata__enriched_out
# Notes:
#
# +----------------------------------------------------------------------------------------+

type: remap
inputs:
  - '*__out*'
  - '*__dropped_out*'
drop_on_error: true
reroute_dropped: true
source: |
  %cloud = {
      "account": {
          "id": get_env_var("NS2_GCP_PROJECT_ID") ?? null,
          "name": get_env_var("NS2_GCP_PROJECT") ?? null
      },
      "host": {
          "id": get_env_var("NS2_GCP_VM_ID") ?? null
      },
      "availability_zone": get_env_var("NS2_GCP_ZONE") ?? null,
      "project": {
          "id": get_env_var("NS2_GCP_PROJECT_ID") ?? null,
          "name": get_env_var("NS2_GCP_PROJECT") ?? null
      },
      "provider": get_env_var("NS2_CLOUD_PROVIDER") ?? null,
      "region": get_env_var("NS2_GCP_REGION") ?? null
  }

  .metadata.cloud.account.id        , _    = get_env_var("NS2_GCP_PROJECT_ID")
  .metadata.cloud.availability_zone , _    = get_env_var("NS2_GCP_ZONE")
  .metadata.cloud.instance.id      , _     = get_env_var("NS2_GCP_VM_ID")
  .metadata.host.ip                        = split(get_env_var("NS2_IP_ADDRESSES") ?? "", ",")
  .metadata.cloud.machine.type      , _    = get_env_var("NS2_GCP_VM_TYPE")
  .metadata.host.image.name         , _    = get_env_var("NS2_GCP_IMAGE")
  .metadata.cloud.instance.id       , _    = get_env_var("NS2_GCP_VM_ID")
  .metadata.cloud.instance.name     , _    = get_env_var("NS2_VM_NAME")
  .metadata.cloud.project.id        , _    = get_env_var("NS2_GCP_PROJECT_ID")
  .metadata.cloud.project.name      , _    = get_env_var("NS2_GCP_PROJECT")
  .metadata.cloud.provider          , _    = get_env_var("NS2_CLOUD_PROVIDER")
  .metadata.cloud.region            , _    = get_env_var("NS2_GCP_REGION")
  .metadata.cloud.service.name      , _    = get_env_var("NS2_GCP_CLOUD_SERVICE")
  .metadata.custom.gcp.log_name            = encode_percent(replace(.metadata.source, ":", "_._") ?? .metadata.custom.vector_group) ?? .metadata.custom.vector_group
  .metadata.custom.gcp.resource.service, _ = get_env_var("NS2_GCP_CLOUD_SERVICE")
  .metadata.custom.gcp.severity            = .metadata.custom.severity
  .metadata                                = compact(.metadata)
...
