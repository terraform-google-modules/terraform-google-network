---
# Synopsis: Installs the iptables-services package and service and configures the system for it.
# Inputs:
#   - templates/journal.j2 - file containing logrotate configuration for journal logs
#
# Outputs:
#   - Installs the iptables-services package and configures logrotate with a custom rule for '/var/log/journal'.

  - name: Ensure that the iptables package is installed
    ansible.builtin.package:
      name: iptables
      state: present
    become: true

  - name: Suse 15 setup with firewalld
    block:
      - name: Check whether the 'ANSIBLE_MANAGED' iptables chain exists
        ansible.builtin.shell: iptables -L ANSIBLE_MANAGED
        register: custom_chain_results
        failed_when: custom_chain_results.rc not in [0,1,127] # continue with install when command not found
        changed_when: false
        become: true

      - name: Check whether the original iptables rules backup file exists
        ansible.builtin.stat:
          path: /etc/sysconfig/iptables-ORIGINAL
        register: original_iptables_rules_result
        become: true

      - name: Create a copy of the original iptables rules
        ansible.builtin.shell: iptables-save > /etc/sysconfig/iptables-ORIGINAL
        become: true
        when:
          - custom_chain_results.rc == 1
          - original_iptables_rules_result.stat.exists | bool == false

      - name: Stop, disable, and mask the firewalld service for SUSE 15
        ansible.builtin.service:
          name: firewalld
          state: stopped
          enabled: false
          masked: true
        become: true

      - name: Check whether the original iptables rules file now exists
        ansible.builtin.stat:
          path: /etc/sysconfig/iptables-ORIGINAL
        register: new_original_iptables_rules_result
        become: true

      - name: Load the original iptables rules to overwrite the rules that come with the iptables-services package
        ansible.builtin.shell: iptables-restore < /etc/sysconfig/iptables-ORIGINAL
        become: true
        when:
          - installed_iptables_services_results is defined
          - installed_iptables_services_results.changed | bool
          - new_original_iptables_rules_result.stat.exists | bool

      - name: Overwrite the default iptables rules that come with the iptables-services package
        ansible.builtin.shell: iptables-save > /etc/sysconfig/iptables
        become: true
        when:
          - installed_iptables_services_results is defined
          - installed_iptables_services_results.changed | bool
    when: ansible_distribution_major_version == '15'

  - name: Configure journal logrotate
    ansible.builtin.template:
      src: journal.j2
      dest: /etc/logrotate.d/journal
    become: true

  - name: Setup the logrotate cron job for journal
    ansible.builtin.cron:
      name: Run logrotate for journalctl
      user: root
      state: present
      minute: '1'
      hour: '*'
      day: '*'
      month: '*'
      weekday: '*'
      job: /usr/sbin/logrotate /etc/logrotate.d/journal > /dev/null 2>&1
    become: true

# NOTE: The iptables service won't start without issuing this command first.
  - name: List the iptables rules
    ansible.builtin.shell: iptables -L
    changed_when: false
    become: true
...
