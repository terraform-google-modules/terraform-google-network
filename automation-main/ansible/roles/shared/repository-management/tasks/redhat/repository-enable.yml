---
# Description: Enables repositories via yum-config-manager
# Inputs:
#   - repository_list_selected: (list) A list of repositories to enable.
#   - enabled_repositories_results: (list) A list of repositories that were enabled before this role was ran.
# Outputs:
#   - Enables each repository that is listed in 'repository_list_selected' via yum-config-manager.

  - name: '[Red Hat] - List the repositories to be enabled'
    debug:
      msg: '{{ repository_list_selected | union( enabled_repositories_results.stdout_lines | default([], true) ) }}'

  - name: '[Red Hat] - Ensure that there is at least one repository to enable'
    fail:
      msg: There must be at least one repository listed in the 'repository_list_selected' or 'enabled_repositories_results' variables.
    when: repository_list_selected | union( enabled_repositories_results.stdout_lines | default([], true) ) | length == 0

  - name: '[Red Hat] - Enable the selected repositories via yum-config-manager'
    shell: yum-config-manager --enable {{ repository_list_selected | union( enabled_repositories_results.stdout_lines | default([], true) ) | join(' --enable
      ') }}
    become: true
  # Repositories listed in rhel_X_repo_list may not exist for a particular minor version. For example,
  # rhel-8-for-x86_64-appstream-e4s-rpms DNE in 8.0 and rhel-ha-for-rhel-7-server-eus-rpms DNE in 7.8.
  # As a stopgap to a more robust solution, ignore errors if we try and add a repository that doesn't
  # exist in a particular OS version's repository list.
    ignore_errors: true

  - name: '[Red Hat] - Update the yum cache'
    yum:
      state: present
      update_cache: true
    register: yum_makecache_results
    failed_when:
      - yum_makecache_results.rc != 0
      - yum_makecache_results.results[0] | regex_search('^There are no enabled repos') | length == 0
    become: true
...
