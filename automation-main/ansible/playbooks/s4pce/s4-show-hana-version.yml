---
# Playbook Name: s4-show-hana-version.yml
# Description: Show version of HANA DB and Add-ons
# Dependencies:
#   - Ansible v2.9+
#   - sudo capability or root privileges on target machine
# Variables:
#   - TASK:
# Example:
#   Execution on remote systems using the any inventory host file
#     ansible-playbook -i <PATH-TO-INVENTORY> s4-show-hana-version.yml -kK
#
# Authors: Naresh Awasthi
# Version: 2.9-000002
# History:
# Modified: 2023-04-05 - Initial playbook creation
#           2023-04-11 - Removed become: true and become_use: {{ sid | lower }}adm at global level and included at task level.
#
# Comments: |


- hosts: all
  gather_facts: false

  vars:
    owner_var: "{{ sid | lower }}adm"

  tasks:
    - name: Check if user exists
      ansible.builtin.shell: "cat /etc/passwd |grep {{ owner_var }}: | awk -F: '{print $1}' "
      register: chk_user_exists

    - name: Fail if user does not exist
      ansible.builtin.fail:
        msg: "user {{ owner_var }} does not exist. Exiting"
      when: chk_user_exists.stdout != owner_var

    - name: Get current version of HANA Components
      ansible.builtin.command: "/hana/shared/{{ sid | upper }}/hdblcm/hdblcm --format=table --action=print_component_list"
      register: show_version
      become: true
      become_user: "{{ sid | lower }}adm"

    - name: Show Version
      ansible.builtin.debug:
        var: show_version.stdout_lines
